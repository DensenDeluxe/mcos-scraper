<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cannabis Preis Tracker</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    /* Dark Theme Anpassungen */
    body {
      padding: 20px;
      background-color: #121212;
      color: #e0e0e0;
    }
    .container {
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
    }
    h1, label {
      color: #ffffff;
    }
    .form-select, .table {
      background-color: #2c2c2c;
      color: #e0e0e0;
      border-color: #444;
    }
    .form-select:focus, .table:focus {
      border-color: #666;
    }
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #252525;
    }
    .table-striped tbody tr:nth-of-type(even) {
      background-color: #2c2c2c;
    }
    table.dataTable thead th {
      background-color: #333333;
      color: #ffffff;
    }
    table.dataTable tbody tr {
      background-color: transparent;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 400px;
    }
    #priceChart {
      width: 100% !important;
      height: auto !important;
    }
    /* Detail Modal */
    .detail-img {
      max-width: 100%;
      height: auto;
      margin-bottom: 1rem;
    }
    .detail-section {
      margin-bottom: 1rem;
    }
    table.dataTable thead .sorting:after {
      content: "⇅";
      float: right;
      opacity: 0.3;
      font-size: 0.8em;
      margin-left: 5px;
    }
    table.dataTable thead .sorting_asc:after {
      content: "▲";
      float: right;
      opacity: 1;
      font-size: 0.8em;
      margin-left: 5px;
    }
    table.dataTable thead .sorting_desc:after {
      content: "▼";
      float: right;
      opacity: 1;
      font-size: 0.8em;
      margin-left: 5px;
    }
    .modal-content {
      background-color: #2c2c2c;
      color: #e0e0e0;
    }
    .modal-header, .modal-footer {
      border-color: #444;
    }
    footer {
      position: fixed;
      right: 20px;
      bottom: 20px;
      font-size: 0.9em;
      color: #aaa;
    }
    a {
      color: #66b2ff;
    }
    a:hover {
      color: #99ccff;
    }
    /* Ladebalken */
    #loadingBarContainer {
      margin-bottom: 20px;
    }
    /* Debug Output Fenster - Breite angepasst */
    #debugOutput {
      background-color: #333;
      color: #fff;
      padding: 10px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.9em;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Cannabis Preis Tracker</h1>
    
    <!-- Ladebalken -->
    <div id="loadingBarContainer">
      <div class="progress">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>
    </div>
    
    <!-- Dropdown für Produkte -->
    <div class="mb-4">
      <label for="productSelect" class="form-label">Produkt auswählen:</label>
      <select id="productSelect" class="form-select">
        <option value="">-- Alle Produkte --</option>
      </select>
    </div>
    
    <!-- Chart-Bereich -->
    <div class="chart-container mb-5">
      <canvas id="priceChart"></canvas>
    </div>
    
    <!-- Interaktive Tabelle -->
    <table id="pricesTable" class="table table-striped">
      <thead>
        <tr>
          <th>Handelsname</th>
          <th>THC Wert</th>
          <th>CBD Wert</th>
          <th>Preis pro Gramm THC</th>
          <th>Tiefstpreis</th>
          <th>Höchstpreis</th>
          <th>Letztes Update</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <!-- Detail-Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel">Produktdetails</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>
        <div class="modal-body" id="detailBody">
          <!-- Dynamischer Inhalt -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer -->
  <footer>
    &copy; Daniel Pett <span id="currentYear"></span>
  </footer>
  
  <!-- Debug Output Fenster -->
  <div id="debugOutput"></div>
  
  <!-- Scripte -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    (function(){
      // Debug-Funktion
      function myDebug(message) {
        const debugDiv = document.getElementById('debugOutput');
        if (debugDiv) {
          const p = document.createElement('p');
          p.textContent = new Date().toLocaleTimeString() + ' - ' + message;
          debugDiv.appendChild(p);
          debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        console.error(message);
      }
      
      // Jahr im Footer aktualisieren
      document.getElementById('currentYear').textContent = new Date().getFullYear();
      
      let indexData = {};
      let chart;
      let dataTable;
      let detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
      
      // Hilfsfunktion zur Extraktion innerer numerischer Werte
      function getNumeric(obj) {
        return (typeof obj === 'object' && obj.value != null) ? obj.value : obj;
      }
      
      function formatPrice(value) {
        if (typeof value === 'number') {
          return value.toFixed(2).replace('.', ',') + ' €';
        }
        return value;
      }
      
      function formatTHC(thc) {
        if (typeof thc === 'object' && thc.value != null) {
          return thc.value.toFixed(1).replace('.', ',') + ' ' + (thc.unit || '');
        } else if (typeof thc === 'number') {
          return thc.toFixed(1).replace('.', ',') + ' %';
        }
        return "n/a";
      }
      
      function formatCBD(cbd) {
        if (typeof cbd === 'object' && cbd.value != null) {
          return cbd.value.toFixed(1).replace('.', ',') + ' ' + (cbd.unit || '');
        } else if (typeof cbd === 'number') {
          return cbd.toFixed(1).replace('.', ',') + ' %';
        }
        return "n/a";
      }
      
      // Vorauswahl: Nur Einträge mit:
      // - gültigem Handelsnamen (nicht leer, nicht "null", "kein eintrag", "undefined")
      // - mindestens einem gültigen Preis (price.value oder price.min/max > 0)
      // - mindestens einem gültigen THC- oder CBD-Wert, wobei die Einheit "%" sein muss
      function isValidProduct(prod) {
        if (!prod.title || prod.title.trim() === "" ||
            ["null", "kein eintrag", "undefined"].includes(prod.title.trim().toLowerCase())) {
          return false;
        }
        if (!prod.price) return false;
        let priceValid = false;
        if (prod.price.value !== undefined && prod.price.value != null && !isNaN(getNumeric(prod.price.value)) && getNumeric(prod.price.value) > 0) {
          priceValid = true;
        }
        if (prod.price.min !== undefined && prod.price.min != null && !isNaN(getNumeric(prod.price.min)) && getNumeric(prod.price.min) > 0) {
          priceValid = true;
        }
        if (prod.price.max !== undefined && prod.price.max != null && !isNaN(getNumeric(prod.price.max)) && getNumeric(prod.price.max) > 0) {
          priceValid = true;
        }
        if (!priceValid) return false;
        let thcValid = false, cbdValid = false;
        if (prod.thc && !isNaN(getNumeric(prod.thc)) && getNumeric(prod.thc) > 0) {
          if (typeof prod.thc === "object" && prod.thc.unit && prod.thc.unit.trim().toLowerCase() === "%") {
            thcValid = true;
          } else if (typeof prod.thc === "number") {
            thcValid = true;
          }
        }
        if (prod.cbd && !isNaN(getNumeric(prod.cbd)) && getNumeric(prod.cbd) > 0) {
          if (typeof prod.cbd === "object" && prod.cbd.unit && prod.cbd.unit.trim().toLowerCase() === "%") {
            cbdValid = true;
          } else if (typeof prod.cbd === "number") {
            cbdValid = true;
          }
        }
        return thcValid || cbdValid;
      }
      
      // Berechnet den Preis pro Gramm THC als Zahl, oder null, wenn nicht berechenbar
      function getPricePerGram(prod) {
        if (!prod.price || !prod.thc || getNumeric(prod.thc) <= 0) return null;
        let basePrice = null;
        if (prod.price.value !== undefined && prod.price.value != null && !isNaN(getNumeric(prod.price.value))) {
          basePrice = parseFloat(getNumeric(prod.price.value));
        } else if (prod.price.min !== undefined && prod.price.max !== undefined && !isNaN(getNumeric(prod.price.min))) {
          basePrice = parseFloat(getNumeric(prod.price.min));
        }
        if (basePrice === null) return null;
        let factor = 1;
        if (prod.cbd && !isNaN(getNumeric(prod.cbd)) && getNumeric(prod.cbd) > 0) {
          factor = (getNumeric(prod.thc) + getNumeric(prod.cbd)) / getNumeric(prod.thc);
        }
        return basePrice * 100 / getNumeric(prod.thc) * factor;
      }
      
      // Manifest laden und alle Produkt-JSONs einlesen, dabei Fortschritt anzeigen
      async function fetchIndex() {
        indexData = {};
        const progressBar = document.getElementById('progressBar');
        try {
          const timestamp = new Date().getTime();
          const manifestResponse = await fetch('./manifest.json?ts=' + timestamp);
          if (!manifestResponse.ok) throw new Error('Manifest konnte nicht geladen werden.');
          const productFiles = await manifestResponse.json();
          const totalFiles = productFiles.length;
          let counter = 0;
          for (let file of productFiles) {
            try {
              const response = await fetch('./jsons/' + file + '?ts=' + timestamp);
              if (!response.ok) throw new Error('Fehler beim Laden von ' + file);
              const data = await response.json();
              let prod = (data.history && Array.isArray(data.history) && data.history.length > 0) ? data.history : data;
              if (!Array.isArray(prod)) prod = [prod];
              const latest = prod[prod.length - 1];
              latest._filename = file;
              if (isValidProduct(latest)) {
                indexData[latest.title] = latest;
              }
            } catch (error) {
              myDebug('Fehler in Datei ' + file + ': ' + error.message);
            }
            counter++;
            const progress = Math.floor((counter / totalFiles) * 100);
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
          }
        } catch (error) {
          myDebug('Manifest-Fehler: ' + error.message);
        }
        // Ladebalken ausblenden
        document.getElementById('loadingBarContainer').style.display = 'none';
        updateProductSelect();
        updateTable();
        setDefaultProduct();
      }
      
      function updateProductSelect() {
        const select = document.getElementById('productSelect');
        select.innerHTML = '<option value="">-- Alle Produkte --</option>';
        const products = Object.keys(indexData)
                              .filter(product => isValidProduct(indexData[product]))
                              .sort((a, b) => a.localeCompare(b));
        products.forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          select.appendChild(option);
        });
      }
      
      function updateTable() {
        const rowsData = [];
        const products = Object.keys(indexData)
                              .filter(product => isValidProduct(indexData[product]))
                              .sort((a, b) => a.localeCompare(b));
        products.forEach(product => {
          const latest = indexData[product];
          const thcValue = latest.thc ? formatTHC(latest.thc) : "n/a";
          const cbdValue = latest.cbd ? formatCBD(latest.cbd) : "n/a";
          
          let priceMin = 'Keine Daten', priceMax = 'Keine Daten';
          let priceMinOrder = 0, priceMaxOrder = 0;
          if (latest.price) {
            if (latest.price.value !== undefined && latest.price.value != null) {
              priceMin = formatPrice(getNumeric(latest.price.value));
              priceMax = formatPrice(getNumeric(latest.price.value));
              priceMinOrder = parseFloat(getNumeric(latest.price.value));
              priceMaxOrder = parseFloat(getNumeric(latest.price.value));
            } else if (latest.price.min !== undefined && latest.price.max !== undefined) {
              priceMin = formatPrice(getNumeric(latest.price.min));
              priceMax = formatPrice(getNumeric(latest.price.max));
              priceMinOrder = parseFloat(getNumeric(latest.price.min));
              priceMaxOrder = parseFloat(getNumeric(latest.price.max));
            }
          }
          
          let pricePerGramTHC = "n/a", pricePerGramTHCOrder = 0;
          if (latest.price && latest.thc && getNumeric(latest.thc) > 0) {
            let basePrice;
            if (latest.price.value !== undefined && latest.price.value != null) {
              basePrice = parseFloat(getNumeric(latest.price.value));
            } else if (latest.price.min !== undefined && latest.price.max !== undefined) {
              basePrice = parseFloat(getNumeric(latest.price.min));
            }
            if (basePrice !== undefined) {
              let factor = 1;
              if (latest.cbd && getNumeric(latest.cbd) > 0) {
                factor = (getNumeric(latest.thc) + getNumeric(latest.cbd)) / getNumeric(latest.thc);
              }
              const calculated = basePrice * 100 / getNumeric(latest.thc) * factor;
              pricePerGramTHC = formatPrice(calculated);
              pricePerGramTHCOrder = parseFloat(calculated.toFixed(2));
            }
          }
          
          const row = [
            product,
            thcValue,
            cbdValue,
            `<span data-order="${pricePerGramTHCOrder}">${pricePerGramTHC}</span>`,
            `<span data-order="${priceMinOrder}">${priceMin}</span>`,
            `<span data-order="${priceMaxOrder}">${priceMax}</span>`,
            new Date(latest.timestamp).toLocaleString()
          ];
          rowsData.push(row);
        });
        
        if (!dataTable) {
          dataTable = $('#pricesTable').DataTable({
            data: rowsData,
            columns: [
              { title: "Handelsname" },
              { title: "THC Wert" },
              { title: "CBD Wert" },
              { title: "Preis pro Gramm THC" },
              { title: "Tiefstpreis" },
              { title: "Höchstpreis" },
              { title: "Letztes Update", orderable: false }
            ],
            responsive: true,
            searching: false,
            lengthChange: false,
            paging: true,
            order: [[3, "asc"]], // Standardmäßig nach "Preis pro Gramm THC" aufsteigend
            language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/de-DE.json" }
          });
        } else {
          dataTable.clear();
          dataTable.rows.add(rowsData);
          dataTable.draw();
        }
        applyProductTypeFilter();
      }
      
      // Setzt das günstigste Produkt als Standard im Dropdown und lädt dessen History
      function setDefaultProduct() {
        let bestProduct = null;
        let bestPrice = Infinity;
        Object.values(indexData).forEach(prod => {
          const ppg = getPricePerGram(prod);
          if (ppg !== null && ppg < bestPrice) {
            bestPrice = ppg;
            bestProduct = prod;
          }
        });
        if (bestProduct) {
          const select = document.getElementById('productSelect');
          select.value = bestProduct.title;
          loadProductHistory(bestProduct);
        }
      }
      
      async function loadProductDetails(product) {
        if (!product) return;
        try {
          const timestamp = new Date().getTime();
          const response = await fetch('./jsons/' + product._filename + '?ts=' + timestamp);
          if (!response.ok) throw new Error('Fehler beim Laden der Detail-JSON');
          const jsonData = await response.json();
          let history = jsonData.history;
          if (!Array.isArray(history)) {
            history = [jsonData];
          }
          updateChart(history);
        } catch (error) {
          myDebug('Detail-JSON Error: ' + error.message);
        }
      }
      
      function showDetailModal(details) {
        const modalTitle = document.getElementById('detailModalLabel');
        const modalBody = document.getElementById('detailBody');
        modalTitle.textContent = details.title;
        let html = "";
        if (details.image_url) {
          html += `<div class="detail-section"><img src="${details.image_url}" alt="${details.title}" class="detail-img"></div>`;
        }
        html += `<div class="detail-section"><strong>Produkttyp:</strong> ${details.product_type}</div>`;
        html += `<div class="detail-section"><strong>THC:</strong> ${formatTHC(details.thc)} &nbsp; <strong>CBD:</strong> ${formatCBD(details.cbd)}</div>`;
        html += `<div class="detail-section"><strong>Preis:</strong> `;
        if (details.price.value !== undefined && details.price.value != null) {
          html += formatPrice(getNumeric(details.price.value));
        } else if (details.price.min !== undefined && details.price.max !== undefined) {
          html += formatPrice(getNumeric(details.price.min)) + " - " + formatPrice(getNumeric(details.price.max));
        } else {
          html += "Keine Daten";
        }
        html += `</div>`;
        if (details.delivery_status) {
          html += `<div class="detail-section"><strong>Lieferstatus:</strong> ${details.delivery_status}</div>`;
        }
        if (details.url) {
          html += `<div class="detail-section"><strong>Mehr Informationen:</strong> <a href="${details.url}" target="_blank">${details.url}</a></div>`;
        }
        modalBody.innerHTML = html;
        detailModal.show();
      }
      
      $('#pricesTable tbody').on('click', 'tr', function() {
        const product = $(this).find('td:first').text();
        loadProductDetails(indexData[product]);
      });
      
      function applyProductTypeFilter() {
        // Hier können zusätzliche Filter implementiert werden – momentan ohne Funktion.
      }
      
      $(document).ready(function() {
        fetchIndex();
      });
      
      async function loadProductHistory(product) {
        if (!product) {
          if (chart) { chart.destroy(); }
          return;
        }
        try {
          const timestamp = new Date().getTime();
          const response = await fetch('./jsons/' + product._filename + '?ts=' + timestamp);
          if (!response.ok) throw new Error('Fehler beim Laden der Produkt-JSON');
          const jsonData = await response.json();
          let history = jsonData.history;
          if (!Array.isArray(history)) {
            history = [jsonData];
          }
          updateChart(history);
        } catch (error) {
          myDebug('History-Error: ' + error.message);
        }
      }
      
      function updateChart(historyData) {
        // Sicherstellen, dass historyData ein Array ist
        if (!Array.isArray(historyData)) {
          historyData = [historyData];
        }
        if (!historyData || historyData.length === 0) {
          if (chart) { chart.destroy(); }
          return;
        }
        let labels = [];
        let minPrices = [];
        let maxPrices = [];
        
        historyData.forEach(entry => {
          labels.push(new Date(entry.timestamp).toLocaleString());
          if (entry.price) {
            if (entry.price.value !== undefined && entry.price.value != null) {
              minPrices.push(getNumeric(entry.price.value));
              maxPrices.push(getNumeric(entry.price.value));
            } else if (entry.price.min !== undefined && entry.price.max !== undefined) {
              minPrices.push(getNumeric(entry.price.min));
              maxPrices.push(getNumeric(entry.price.max));
            } else {
              minPrices.push(null);
              maxPrices.push(null);
            }
          } else {
            minPrices.push(null);
            maxPrices.push(null);
          }
        });
        
        if (historyData.length === 1) {
          labels.push(labels[0]);
          minPrices.push(minPrices[0]);
          maxPrices.push(maxPrices[0]);
        }
        
        const ctx = document.getElementById('priceChart').getContext('2d');
        if (chart) { chart.destroy(); }
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              { label: 'Tiefstpreis', data: minPrices, borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: false },
              { label: 'Höchstpreis', data: maxPrices, borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: false }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                display: false, // Achsentitel und Ticks ausblenden
                grid: {
                  color: 'rgba(200, 200, 200, 0.3)' // Helleres Gitter
                }
              },
              y: {
                grid: {
                  color: 'rgba(200, 200, 200, 0.3)' // Helleres Gitter
                },
                title: {
                  display: true,
                  text: 'Preis'
                }
              }
            },
            plugins: { legend: { display: true } }
          }
        });
      }
      
      document.getElementById('productSelect').addEventListener('change', function() {
        const selected = this.value;
        if (selected === "") {
          updateTable();
          if (chart) { chart.destroy(); }
        } else {
          const prod = indexData[selected];
          updateTable();
          loadProductHistory(prod);
        }
      });
    })();
  </script>
</body>
</html>
